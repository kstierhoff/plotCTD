---
title: "CTD and UCTD casts"
author: "Kevin L. Stierhoff"
date: '`r format(Sys.time(), "%d %B %Y")`'
output:
  html_document:
    toc: yes
---

```{r SetUp,echo=FALSE,warning=FALSE,message=FALSE,include=FALSE}
# Install and load pacman (library management package)
if (!require("pacman")) install.packages("pacman")

# Install and load required packages from CRAN ---------------------------------
pacman::p_load(tidyverse,cowplot,devtools,knitr,shadowtext,plotly,sf,fs,
               DBI,stringr,gdata,forecast,lubridate,here,rnaturalearth,viridis,
               DT,mapview)

# Install and load required packages from Github -------------------------------
# surveyR
pacman::p_load_gh("kstierhoff/surveyR")
# rnaturalearth data
pacman::p_load_gh("ropenscilabs/rnaturalearthdata")
pacman::p_load_gh("ropenscilabs/rnaturalearthhires")

# List packages required to run the script
pkgs <- c("tidyverse","xlsx","cowplot","devtools","knitr",
          "DBI","stringr","gdata","forecast")

# User input
survey.name   <- "1807RL"
survey.vessel <- "FSV Reuben Lasker" 
survey.dir    <- "C:/SURVEY/1807RL"
data.dir      <- "C:/SURVEY/1807RL/DATA"

# Control script behavior
copy.files      <- T # copy data files from data to plotCTD directory
overwrite.files <- T # overwrite existing files
get.nav         <- T # download nav data from ERDDAP
process.files   <- T # process CTD/UCTD files
draw.figures    <- T # create new figures
get.map         <- T # download map from rnaturalearth

# set system time zone to GMT
Sys.setenv(tz = "GMT")

# determines method of table generation for best formatting
doc.type <- knitr::opts_knit$get("rmarkdown.pandoc.to")
if (is.null(doc.type)) {
  doc.type <- "html"
}

# global knitr chunk options
knitr::opts_chunk$set(
  echo = F, warning = F, message = F, 
  fig.align = "center", dev = "png", dev.args = list(type = "cairo"), dpi = 150
)
```  

```{r UserInput}
# Define ERDDAP data variables
survey.vessel.erddap <- "WTEGnrt" # Lasker == WTEG; Shimada == WTED; add "nrt" if using near-realtime data (e.g., WTEGnrt)
survey.start         <- "2018-06-25" # Start of survey for ERDDAP vessel data query
survey.end           <- "2018-09-23" # End of survey for ERDDAP vessel data query
erddap.vars          <- c("time,latitude,longitude,platformSpeed")
erddap.classes       <- c("factor", "numeric", "numeric", "numeric")
erddap.headers       <- c("time", "lat", "long", "SOG")

# Define Leg breaks; e.g. "YYYY-MM-DD"
leg.breaks <- as.numeric(as.POSIXct(c("2018-06-24", "2018-07-20", 
                                      "2018-08-13", "2018-09-05"),
                         format = "%F"))

# CTD/UCTD header info
uctd.prefix <- "1807RL_\\d{3}_UCTD\\d{3}"
ctd.prefix  <- "1807\\d{3}"

exclude.ctd <- c("1807RL_056_UCTD131")

# Define map height and width (inches) for saved images
map.height <- 10 # e.g., 8 for spring surveys, 10 for summer surveys
map.width  <-  6 # e.g., 8 for spring surveys, 6 for summer surveys
```  

```{r FilterVariables}
# Set min and max values for temperature, salinity, etc.
# Temperature limits
min.T <- 0
max.T <- 25

# Salinity limits
min.S <- 30
max.S <- 35

# Map landmarks
label.list <- c("Monterey Bay","San Francisco","Cape Flattery","Crescent City",
                "Newport","Point Conception","Cape Mendocino","Columbia River",
                "Cape Blanco","Bodega Bay","Westport","Fort Bragg",
                "Morro Bay","Long Beach","Cape Scott","San Diego")
```

```{r CopyFiles, include=F}
if (copy.files) {
  # Copy UCTD data #####
  # location of header files on survey directory
  uctd.hdr <- list.files(file.path(data.dir, "UCTD"), 
                         pattern = paste(uctd.prefix, ".asc", sep = ""), 
                         full.names = T)
  # copy files to plotCTD directory
  file.copy(uctd.hdr, here("Data/UCTD"), overwrite = overwrite.files)
  
  # location of processed UCTD files on survey directory
  uctd.proc <- list.files(file.path(data.dir, "UCTD"), 
                          pattern = paste(uctd.prefix,"_processed.asc", sep = ""),
                          full.names = T)
  
  # copy files to plotCTD directory
  file.copy(uctd.proc, here("Data/UCTD"), overwrite = overwrite.files)
  
  # Copy CTD data #####
  # list raw CTD ASCII files
  ctd.hdr <- list.files(file.path(data.dir, "CTD"),
                        pattern = paste(ctd.prefix,".hdr", sep = ""),
                        full.names = T)
  
  # copy files to plotCTD directory
  file.copy(ctd.hdr, here("Data/CTD"), overwrite = overwrite.files)
  
  # location of processed CTD files on survey directory
  ctd.proc <- list.files(file.path(data.dir, "CTD"),
                        pattern = paste(ctd.prefix,"_processed.asc", sep = ""),
                        full.names = T)
  
  # copy files to plotCTD directory
  file.copy(ctd.proc, here("Data/CTD"),
            overwrite = overwrite.files)
}
```

```{r ProcessNav}
if (get.nav) {
  # Generate ERDDAP URL
  dataURL <- URLencode(paste("http://coastwatch.pfeg.noaa.gov/erddap/tabledap/fsuNoaaShip",
                             survey.vessel.erddap, ".csv0?", erddap.vars,
                             "&time>=", survey.start, "&time<=", survey.end,
                             sep = ""))
  
  # Download and parse ERDDAP nav data
  nav <- data.frame(read.csv(dataURL, header = F, colClasses = erddap.classes, 
                             row.names = NULL, skip = 0))
  names(nav) <- erddap.headers
  
  # Filter to remove bad SST values
  nav <- nav %>% 
    mutate(long = long - 360,
           SOG = SOG * 1.94384) %>%
    filter(is.nan(SOG) == F, SOG > 0, SOG < 15) %>%
    filter(between(lat, 30, 54), between(long, -135, -116)) %>%
    mutate(datetime = as.POSIXct(time, format = "%FT%T"),
           leg = paste("Leg", cut(as.numeric(datetime), leg.breaks, labels = F)))
  
  # save results
  save(nav,file = here("Data/nav_data.Rdata"))
} else {
  load(here("Data/nav_data.Rdata"))
}
```

```{r ProcessUCTDCasts}
# Process UCTD header files #####
# List raw UCTD ASCII files
uctd.hdr <- list.files(here("Data/UCTD"), 
                       pattern = paste(uctd.prefix, ".asc", sep = ""), 
                       full.names = T)

# Create empty figure if no UCTD casts present
if (length(uctd.hdr) == 0) {
  df <- data.frame()
  uctd.empty <- ggplot(df) + geom_point() + 
    xlim(0,10) + ylim(0,10) + 
    annotate('text', 5, 5, label = 'No UCTD Casts', size = 6, fontface = 'bold') +
    theme_bw()  
  
  ggsave(ctd.empty, filename = here("Figs/uctd_missing.png"))
  
} else {
  if (process.files) {
    # Create a data frame for header info  
    all.uctd.hdr <- data.frame()
    for (i in uctd.hdr) {
      # scan header for text extraction
      txt <- readLines(i)
      # extract cast date as POSIXct
      cast.date  <- as.POSIXct(str_extract(
        unlist(str_extract_all(txt, pattern = '\\*Cast[\\s\\S]*end')),
        "\\d{2}\\s\\w{3}\\s\\d{4}\\s\\d{2}:\\d{2}:\\d{2}"),
        format = "%d %b %Y %H:%M:%S")
      if (length(cast.date) == 0) {
        cast.date  <- as.POSIXct(str_extract(
          unlist(str_extract_all(txt, pattern = '\\*Cast[\\s\\S]*stop')),
          "\\d{2}\\s\\w{3}\\s\\d{4}\\s\\d{2}:\\d{2}:\\d{2}"),
          format = "%d %b %Y %H:%M:%S")
      }
      # extract probe serial number
      sn <- as.numeric(str_extract(
        unlist(str_extract_all(txt, pattern = '\\*SerialNumber=\\d{8}'))[1],"\\d{8}"))
      # create a factor for the cast name
      cast.file <- tail(str_split(i, "/")[[1]], n = 1)
      cast <- str_replace(cast.file, ".asc","")
      # assemble a temporary data frame and add to all.uctd.hdr
      all.uctd.hdr <- bind_rows(all.uctd.hdr,
                                data.frame(cast, cast.date, sn))
    }
    
    # Process UCTD cast files #####
    # list processed UCTD ASCII files
    uctd.proc <- list.files(here("Data/UCTD"), 
                            pattern = paste(uctd.prefix,"_processed.asc", sep = ""),
                            full.names = T)
    
    # create a data frame for storing results
    all.uctd <- data.frame()
    for (i in uctd.proc) {
      # read the ucast and rename columns
      ucast <- read.table(i, header = T)
      # names(ucast) <- c("scan","C","T","P","Z","dZt","S","sV","flag")
      names(ucast) <- c("scan","C","T","P","Z","S","Sv","avgsVCM","Dens","Flag")
      # calculate time (s) from scan (scan rate is 16 Hz)
      ucast$scan <- ucast$scan - ucast$scan[1]
      ucast$s <- ucast$scan/16
      # calculate time interval (dt, s)
      ucast$dt[2:dim(ucast)[1]] <- ucast$s[2:dim(ucast)[1]] - ucast$s[1:(dim(ucast)[1] - 1)]
      ucast$dt[1] <- ucast$dt[2]
      # calculate change in depth (dZ, m)
      ucast$dZ[2:dim(ucast)[1]] <- ucast$Z[2:dim(ucast)[1]] - ucast$Z[1:(dim(ucast)[1] - 1)]
      # calculate descent rate (dZt, m/s)
      ucast$dZt <- ucast$dZ / ucast$dt
      ucast$dZt <- as.numeric(ma(ucast$dZt, order = 5))
      # make depth negative
      ucast$Z <- -ucast$Z
      # add ucast name to df
      cast.file <- tail(str_split(i, "/")[[1]], n = 1)
      ucast$cast <- str_replace(cast.file, "_processed.asc","")
      # add to resultsConductivity Depth Plot
      all.uctd <- bind_rows(all.uctd,ucast)
    }
    # Format results
    all.uctd <- arrange(all.uctd, cast, scan) %>% 
      filter(S < max.S, S > min.S) # Remove bad salinity data
    
    # save results 
    save(all.uctd, all.uctd.hdr, uctd.hdr, 
         file = here("Data/uctd_data.Rdata"))
  } else {
    load(here("Data/uctd_data.Rdata"))
  }
  
  # Match UCTD headers to nav data
  nav.match.uctd <- data.frame()
  for (i in 1:nrow(all.uctd.hdr)) {
    min.diff <- which.min(abs(difftime(all.uctd.hdr$cast.date[i],nav$datetime)))
    nav.match.uctd <- bind_rows(nav.match.uctd,nav[min.diff, ])
  }
  
  # combine header and nav data
  all.uctd.hdr <- all.uctd.hdr %>% 
    bind_cols(nav.match.uctd) %>% 
    mutate(lag = difftime(cast.date, datetime)) %>% 
    arrange(cast.date)
  
  # summarize UCTD cast results
  uctd.summ <- all.uctd %>% 
    group_by(cast) %>% 
    summarise(
      time = round(sum(dt),0),
      max.depth = round(min(Z),0))
  
  # summarize UCTD cast results
  uctd.summ <- uctd.summ %>%
    left_join(select(all.uctd.hdr, cast, cast.date, lat, long, SOG)) %>%
    arrange(cast.date) %>%
    mutate(cast.num = seq(1, n()),
           leg = paste("Leg", cut(as.numeric(cast.date), leg.breaks, labels = F)))
  
  # write table to CSV
  write.csv(uctd.summ, file = here("Output/cast_summary_uctd.csv"), quote = F, row.names = F)
  
  # add SOG to all.uctd
  all.uctd <- all.uctd %>% 
    left_join(select(uctd.summ, cast, SOG)) %>% 
    mutate(survey = as.factor(survey.name))
  
  # summarize uctd casts for water classification
  uctd.class <- 
    group_by(all.uctd, cast) %>% 
    summarise(
      min.T = min(T),
      min.S = min(S),
      max.T = max(T),
      max.S = max(S)
    ) %>% 
    # assign classes based on salinity
    mutate(class = case_when(
      min.S <= 31.4 ~ "Plume",
      min.S >= 33.4 ~ "Spicy",
      TRUE ~ "CC"))

  # add water mass to the summary table and cast data for plotting
  all.uctd <- all.uctd %>% 
    left_join(uctd.class[ ,c("cast","class")]) %>% 
    left_join(select(uctd.summ, cast, leg))
  
  uctd.summ <- uctd.summ %>% 
    left_join(uctd.class[ ,c("cast","class")]) %>% 
    select(cast.num, cast, cast.date, lat, long, SOG, 
           time, max.depth, class, leg)
  
  # Remove unprocessed casts from the summary
  uctd.missing <- all.uctd.hdr %>% 
    filter(!cast %in% all.uctd$cast)
  
  # Exclude bad casts
  all.uctd <- all.uctd %>%
    filter(!cast %in% exclude.ctd)
  
  # Write table to CSV
  write.csv(uctd.missing, file = here("Output/unprocessed_uctd.csv"), 
            quote = F, row.names = F)
}
```

```{r ProcessCTDCasts}
# List raw UCTD ASCII files
ctd.hdr <- list.files(here("Data/CTD"),
                      pattern = paste(ctd.prefix,".hdr", sep = ""),
                      full.names = T)

# Create empty figure if no CTD casts present
if (length(ctd.hdr) == 0) {
  df <- data.frame()
  
  ctd.empty <- ggplot(df) + geom_point() + 
    xlim(0,10) + ylim(0,10) + 
    annotate('text', 5, 5, label = 'No CTD Casts', size = 6, fontface = 'bold') +
    theme_bw()  
  
  ggsave(ctd.empty, filename = here("Figs/ctd_missing.png"))
  
} else {
  if (process.files) {
    # Extract the deployment time and other info from the header file
    # Create a data frame for header info
    all.ctd.hdr <- data.frame()
    for (i in ctd.hdr) {
      # create a factor for the cast name
      cast.file <- tail(str_split(i, "/")[[1]], n = 1)
      cast <- str_replace(cast.file, ".hdr","")
      # scan header for text extraction
      txt <- readLines(i)
      # extract cast date as POSIXct
      cast.date  <- as.POSIXct(str_extract(
        unlist(str_extract_all(txt, pattern = '\\* NMEA UTC \\(Time\\).*')),
        "\\w{3}\\s\\d{2}\\s\\d{4}\\s*\\d{2}:\\d{2}:\\d{2}"),
        format = "%b %d %Y %H:%M:%S") # * NMEA UTC (Time) = Jun 29 2016 15:15:09
      if (length(cast.date) == 0) {
        cast.date  <- as.POSIXct(str_extract(
          unlist(str_extract_all(
            txt, pattern = '\\*Cast[\\s\\S]*stop')),"\\d{2}\\s\\w{3}\\s\\d{4}\\s\\d{2}:\\d{2}:\\d{2}"),
          format = "%d %b %Y %H:%M:%S")
      }
      # assemble a temporary data frame and add to all.uctd.hdr
      all.ctd.hdr <- bind_rows(all.ctd.hdr,
                               data.frame(cast, cast.date))
    }
    
    # list processed CTD ASCII files
    ctd.proc <- list.files(here("Data/CTD"),
                           pattern = paste(ctd.prefix,"_processed.asc", sep = ""),
                           full.names = T)
    
    # create a data frame for storing results
    all.ctd <- data.frame()
    for (i in ctd.proc) {
      # read the ucast and rename columns
      cast <- read.table(i, header = T)
      names(cast) <- c("P","T","C","Z","S","Sv","avgsVCM","Dens","Flag")
      # make depth negative
      cast$Z <- -cast$Z
      # add cast name to df
      cast.file <- tail(str_split(i, "/")[[1]], n = 1)
      cast$cast <- str_replace(cast.file, "_processed.asc","")
      # add to resultsConductivity Depth Plot
      all.ctd <- bind_rows(all.ctd, cast)
    }
    
    # save results
    save(all.ctd, all.ctd.hdr, file = here("Data/ctd_data.Rdata"))
  } else {
    load(here("Data/ctd_data.Rdata"))
  }
  
  # Match UCTD headers to nav data
  nav.match.ctd <- data.frame()
  for (i in 1:nrow(all.ctd.hdr)) {
    min.diff <- which.min(abs(difftime(all.ctd.hdr$cast.date[i], nav$datetime)))
    nav.match.ctd <- bind_rows(nav.match.ctd, nav[min.diff, ])
  }
  
  # combine header and nav data
  all.ctd.hdr <- all.ctd.hdr %>% 
    bind_cols(nav.match.ctd) %>% 
    mutate(
      cast.num = seq(1, n()),
      lag = difftime(cast.date, datetime))
  
  # reorder all.ctd by cast and depth
  all.ctd <- arrange(all.ctd, cast, desc(Z)) %>% 
  # filter all.ctd to remove bad temperature and salinity 
    filter(T > min.T, T < max.T) %>% 
    filter(S > min.S, S < max.S) %>%
    droplevels()

  # calculate max depth of each cast
  ctd.depth <- all.ctd %>% 
    group_by(cast) %>% 
    summarise(max.depth = min(Z))
  
  # extract cast number from filename
  all.ctd.hdr <- all.ctd.hdr %>% 
    left_join(ctd.depth)
  
  # summarize uctd casts for water classification
  ctd.class <- all.ctd %>% 
    group_by(cast) %>% 
    summarise(
      min.T = min(T),
      min.S = min(S),
      max.T = max(T),
      max.S = max(S)) %>% 
    # assign classes based on salinity
    mutate(class = case_when(
      min.S <= 31.4 ~ "Plume",
      min.S >= 33.4 ~ "Spicy",
      TRUE ~ "CC"))
  
  all.ctd.hdr <- all.ctd.hdr %>% 
    left_join(select(ctd.class, cast, class)) %>% 
    mutate(leg = paste("Leg", cut(as.numeric(cast.date), leg.breaks, labels = F))) %>% 
    select(cast.num, cast, cast.date, lat, long, max.depth, class, leg)
  
  # add water mass to the summary table and cast data for plotting
  all.ctd     <- all.ctd %>% 
    left_join(select(ctd.class, cast, class)) %>% 
    left_join(select(all.ctd.hdr, cast, leg))  
  
  # write table to CSV
  write.csv(all.ctd.hdr, file = here("Output/cast_summary_ctd.csv"), 
            quote = F, row.names = F)
  
  # Remove unprocessed casts from the summary
  ctd.missing <- all.ctd.hdr %>% 
    filter(!cast %in% all.ctd$cast)
  
  # Exclude bad casts
  all.ctd <- all.ctd %>%
    filter(!cast %in% exclude.ctd)
  
  # write table to CSV
  write.csv(ctd.missing, file = here("Output/unprocessed_ctd.csv"), 
            quote = F, row.names = F)
}
```

```{r CreateBaseMap}
# Import landmarks
locations <- filter(read.csv(here("Data/Map/locations.csv")), name %in% label.list)
# configure map parameters
map.bounds <- map_bounds(all.uctd.hdr$lat, all.uctd.hdr$long, 0.10)

# Get map data
if (get.map) {
  na_sf <- ne_countries(scale = "large", returnclass = "sf") %>%
    filter(subregion %in% c("Northern America","Central America"))
  save(na_sf, file = here("Data/Map/land_sf.Rdata"))
} else {
  load(here("Data/Map/land_sf.Rdata"))
}

# create base map
# Create base map
base.map <- ggplot() +
  # Plot high-res land polygons
  geom_sf(data = na_sf, fill = "white", color = "tan4") +
  # Plot landmarks
  geom_point(data = locations, aes(lon,lat), size = 2,colour = 'tan4') +
  geom_shadowtext(data  = locations, aes(lon,lat, label = name), colour = 'gray20', size = 2,
                  fontface = 'bold', hjust = 0, nudge_x = 0.2, nudge_y = 0.05, 
                  angle = 25, bg.color = "white") +
  # Format axes and titles
  xlab("Longitude") + ylab("Latitude") + 
  coord_sf(
    xlim = map.bounds$range.lon,
    ylim = map.bounds$range.lat) +
  theme_bw() + 
  theme(axis.text.y          = element_text(angle = 90, hjust = 0.5),
        legend.position      =  c(0,0),
        legend.justification = c(0,0),
        legend.background    = element_blank(),
        legend.key           = element_blank(),
        panel.background     = element_rect(fill = alpha("lightblue", 0.5)),
        plot.title           = element_text(hjust = 0.5),
        panel.grid.major     = element_line(color = "white"))

# save plot
ggsave(base.map, filename = here("Figs/basemap.png"), 
       width = map.width, height = map.height)
```

# Underway CTD (UCTD) Results
## Cast summary  
Summary of underway CTD (UCTD) casts conducted during the `r survey.name` aboard _`r survey.vessel`_. 

```{r UCTDCastSummary, include=TRUE}
if (length(uctd.hdr) > 0) {
  # make a copy of uctd.summ
  uctd.table <- uctd.summ %>% 
    arrange(cast.date) %>% 
    mutate(cast.date = format(cast.date,"%m/%d/%Y %H:%M:%S"))
  
  # rename columns
  names(uctd.table) <- c("Cast","Filename","Date/time","Lat","Lon",
                         "SOG (kt)","Time (s)","Depth (m)","Class","Leg")
  # print table
  datatable(uctd.table)  
} else {
  cat("No UCTD casts processed.")
}
```  

## Unprocessed UCTD casts  
List of UCTD casts not yet processed. 

```{r UCTDMissingCasts, include=TRUE}
if (nrow(uctd.missing) > 0) {
  # make a copy of uctd.summ
  uctd.tbl.missing <- uctd.missing %>%
    arrange(cast.date) %>%
    mutate(cast.date = format(cast.date,"%m/%d/%Y %H:%M:%S")) %>% 
    select(Cast = cast, Date = cast.date, Leg = leg)
  
  # print table
  datatable(uctd.tbl.missing)  
} else {
  cat("All UCTD casts have been processed.")
}
```  

## Cast locations
Location of underway UCTD (red numbers) casts. Gray numbers indicate acoustic transect line numbers from the survey instructions. UCTD cast numbers correspond to those in the previous table.  
```{r CreateMapData}
# Configure mapview options
mapviewOptions(basemaps = c("Esri.OceanBasemap","Esri.WorldImagery","CartoDB.Positron"))

# Create simple features
nav.sf <- st_as_sf(nav, coords = c("long","lat"),crs = 4326) %>% 
  group_by(leg) %>% 
  summarise(do_union = F) %>% 
  st_cast("LINESTRING")

uctd.sf <- st_as_sf(uctd.summ, coords = c("long","lat"),crs = 4326) 
ctd.sf  <- st_as_sf(all.ctd.hdr, coords = c("long","lat"),crs = 4326)  
```

```{r AllUctdMap}
if (length(uctd.hdr) > 0) {
  if (draw.figures) {
    if (length(uctd.table) > 0) {
      # create main map using ggmap
      map.uctd <- base.map + 
        geom_path(data = nav, aes(long, lat)) +
        geom_shadowtext(data = uctd.table, aes(x = Lon, y = Lat, label = Cast, colour = Leg),
                        size = 3, bg.color = "white", fontface = "bold") 
    } else {
      # create main map using ggmap
      map.uctd <- base.map + 
        geom_path(data = nav, aes(long, lat)) +
        geom_shadowtext(aes(mean(map.bounds$range.lon), mean(map.bounds$range.lat), label = "No UCTD casts"), 
                        colour = "black", bg.color = "red", size = 6, fontface = "bold")
    }
    # save map
    ggsave(here("Figs/map_uctd.png"), map.uctd, 
           width = map.width, height = map.height)
  }
}
# Map casts
mapview(nav.sf, color = "black", alpha = 0.5, 
        layer.name = "Vessel track", col.regions = "black") +
  mapview(uctd.sf, zcol = c("leg"), cex = 4, 
          layer.name = "UCTD Casts", legend = T)
```  

## Descent rate v. Depth plot
Descent rate of the UCTD by depth and vessel speed.  

```{r DescentRateDepthPlot,out.width="90%",out.height="90%"}
if (length(uctd.hdr) > 0) {
  if (draw.figures) {
    # plot descent rate v depth
    uctd.dZt <- ggplot(data = all.uctd, aes(dZt, Z, group = cast, colour = SOG)) + 
      geom_path(alpha = 0.75) +
      xlab("\nDescent rate (m/s)") + ylab("Depth (m)\n") + 
      scale_x_continuous(limits = c(0,ceiling(max(all.uctd$dZt,na.rm = T))),
                         breaks = seq(0, ceiling(max(all.uctd$dZt,na.rm = T)), 0.5), 
                         expand = c(0,0)) + 
      scale_y_continuous(limits = c(round(min(all.uctd$Z), digits = -1),0),
                         breaks = seq(round(min(all.uctd$Z),digits = -1), 0, 25), 
                         expand = c(0, 0)) + 
      scale_colour_viridis("Vessel\nspeed (kt)\n", option = "plasma") +
      facet_wrap(~leg, ncol = 2) +
      theme_bw() + 
      theme(panel.grid.major     = element_line(size = 0.75),
            legend.position      =  c(0,1),
            legend.justification = c(0,1),
            legend.background    = element_blank(),
            strip.background.x = element_blank(),
            strip.text.x = element_text(face = "bold"))
    # save plot
    ggsave(uctd.dZt, file = here("Figs/uctd_dZt_v_Z.png"))
  }
  ggplotly(uctd.dZt)
  # include_graphics(here("Figs/uctd_dZt_v_Z.png")) 
} else {
  include_graphics(here("Figs/uctd_missing.png"))
}
```

## Depth v. Time plot
The dashed line represent the Loess-smoothed depth profiles.  

```{r DepthTimePlot,out.width="90%",out.height="90%"}
if (length(uctd.hdr) > 0) {
  if (draw.figures) {
    # plot depth v time
    uctd.Z <- ggplot(data = all.uctd, aes(s, Z, group = factor(cast), colour = SOG)) + 
      geom_path(alpha = 0.75) +
      xlab("\nTime (s)") + ylab("Depth (m)\n") + 
      scale_x_continuous(limits = c(0,max(all.uctd$s) + 10),
                         breaks = seq(0, max(all.uctd$s) + 10, 25),
                         expand = c(0,0)) + 
      scale_y_continuous(limits = c(round(min(all.uctd$Z),digits = -1),0),
                         breaks = seq(round(min(all.uctd$Z),digits = -1), 0, 25),
                         expand = c(0,0)) + 
      scale_colour_viridis("Vessel\nspeed (kt)\n", option = "plasma") +
      facet_wrap(~leg, ncol = 2) +
      theme_bw() + 
      theme(panel.grid.major     = element_line(size = 0.75),
            legend.position      = c(1,1),
            legend.justification = c(1,1),
            legend.background    = element_blank(),
            strip.background.x = element_blank(),
            strip.text.x = element_text(face = "bold")) +
      geom_smooth(data = all.uctd, se = F, aes(s, Z, group = survey), 
                  colour = 'black', linetype = 2)
    # save plot
    ggsave(uctd.Z, file = here("Figs/uctd_Z_v_time.png"))
  }
  ggplotly(uctd.Z)
  # include_graphics(here("Figs/uctd_Z_v_time.png")) 
} else {
  include_graphics(here("Figs/uctd_missing.png"))
}
```  

## Temperature v. Depth plot

```{r TemperatureDepthPlot,out.width="90%",out.height="90%"}
if (length(uctd.hdr) > 0) {
  if (draw.figures) {
    # plot temperature v depth
    uctd.T <- ggplot(data = all.uctd, aes(T, Z, group = cast, colour = factor(cast))) + 
      geom_path(alpha = 0.75) +
      xlab("\nTemperature (C)") + ylab("Depth (m)\n") + 
      scale_x_continuous(limits = c(round(min(all.uctd$T),0) - 1, round(max(all.uctd$T),0) + 1),
                         breaks = seq(round(min(all.uctd$T),0) - 1, round(max(all.uctd$T), 0) + 1, 2),
                         expand = c(0,0)) + 
      scale_y_continuous(limits = c(round(min(all.uctd$Z), digits = -1),0),
                         breaks = seq(round(min(all.uctd$Z), digits = -1), 0, 25), 
                         expand = c(0,0)) +
      facet_wrap(~leg, ncol = 2) +
      theme_bw() +
      theme(panel.grid.major = element_line(size = 0.75), 
            legend.position = "none",
            strip.background.x = element_blank(),
            strip.text.x = element_text(face = "bold"))
    # save plot
    ggsave(uctd.T, file = here("Figs/uctd_T_v_Z.png"))
  }
  ggplotly(uctd.T)
  # include_graphics(here("Figs/uctd_T_v_Z.png"))
} else {
  include_graphics(here("Figs/uctd_missing.png"))
}
```

## Salinity v. Depth plot

```{r SalinityDepthPlot,out.width="90%",out.height="90%"}
if (length(uctd.hdr) > 0) {
  if (draw.figures) {
    # plot salinity v depth
    uctd.S <- ggplot(data = all.uctd, aes(S, Z, group = cast, colour = factor(cast))) + 
      geom_path(alpha = 0.75) +
      xlab("\nSalinity") + ylab("Depth (m)\n") +
      scale_x_continuous(limits = c(round(min(all.uctd$S), 2) - 0.1, round(max(all.uctd$S), 2) + 0.1),
                         breaks = seq(round(min(all.uctd$S),2) - 0.1, round(max(all.uctd$S), 2) + 0.1, 1),
                         expand = c(0,0)) +  
      scale_y_continuous(limits = c(round(min(all.uctd$Z), digits = -1), 0),
                         breaks = seq(round(min(all.uctd$Z), digits = -1), 0, 25), 
                         expand = c(0,0)) + 
      facet_wrap(~leg, ncol = 2) +
      theme_bw() +
      theme(panel.grid.major = element_line(size = 0.75), 
            legend.position = "none",
            strip.background.x = element_blank(),
            strip.text.x = element_text(face = "bold"))
    # save plot
    ggsave(uctd.S,file = here("Figs/uctd_S_v_Z.png"))
  }
  ggplotly(uctd.S)
  # include_graphics(here("Figs/uctd_S_v_Z.png")) 

} else {
  include_graphics(here("Figs/uctd_missing.png"))
}
```

## Sound speed v. Depth plot

```{r SoundSpeedDepthPlot,out.width="90%",out.height="90%"}
if (length(uctd.hdr) > 0) {
  if (draw.figures) {
    # plot sound speed v depth
    uctd.Sv <- ggplot(data = all.uctd, aes(Sv, Z, group = cast, colour = factor(cast))) + 
      geom_path(alpha = 0.75) +
      xlab("\nSound speed (m/s)") + ylab("Depth (m)\n") +
      scale_x_continuous(limits = c(round(min(all.uctd$Sv), 0) - 1, round(max(all.uctd$Sv), 0) + 1),
                         breaks = seq(round(min(all.uctd$Sv),0) - 1, round(max(all.uctd$Sv),0) + 1, 10),
                         expand = c(0,0)) +  
      scale_y_continuous(limits = c(round(min(all.uctd$Z), digits = -1), 0),
                         breaks = seq(round(min(all.uctd$Z), digits = -1), 0, 25),
                         expand = c(0,0)) + 
      facet_wrap(~leg, ncol = 2) +
      theme_bw() +
      theme(panel.grid.major = element_line(size = 0.75), 
            legend.position = "none",
            strip.background.x = element_blank(),
            strip.text.x = element_text(face = "bold"))
    # save plot
    ggsave(uctd.Sv, file = here("Figs/uctd_sV_v_Z.png"))
  }
  ggplotly(uctd.Sv)
  # include_graphics(here("Figs/uctd_sV_v_Z.png"))
} else {
  include_graphics(here("Figs/uctd_missing.png"))
}
```

## Temperature-Salinity plot
Temperature-salinity plot for all UCTD casts (left) and the location of UCTD casts (right), symbolized by water mass.

```{r UCTDTsPlot}
if (length(uctd.hdr) > 0) {
  if (draw.figures) {
    # plot salinity v depth
    uctd.TS <- ggplot(data = all.uctd, aes(S, T, group = cast, colour = factor(class))) + 
      geom_point(alpha = 0.5, size = 2) +
      xlab("\nSalinity") + ylab("Temperature (C)\n") +
      scale_x_continuous(limits = c(29,35),
                         breaks = seq(29,35,1),expand = c(0,0)) +  
      scale_y_continuous(limits = c(floor(min(all.uctd$T)), ceiling(max(all.uctd$T))),
                         breaks = seq(floor(min(all.uctd$T)), ceiling(max(all.uctd$T)),2), 
                         expand = c(0,0)) + 
      scale_colour_hue("Water\nmass") +
      theme_bw() +
      theme(panel.grid.major     = element_line(size = 0.75),
            legend.position      = c(0,0),
            legend.justification = c(0,0),
            legend.background    = element_blank(),
            strip.background.x = element_blank(),
            strip.text.x = element_text(face = "bold"))
    # save plot
    ggsave(uctd.TS,file = here("Figs/uctd_S_v_T.png"))
    
    # create main map using ggmap
    map.uctd.TS <- base.map + 
      geom_path(data = nav, aes(long, lat)) + 
      geom_point(data = uctd.table, aes(x = Lon, y = Lat, colour = Class), 
                 size = 2, alpha = 0.75) +
      scale_colour_hue() +
      theme(panel.grid.major = element_line(size = 0.75),
            legend.position =  c(0,0),
            legend.justification = c(0,0),
            legend.background = element_blank())
    
    # combine plots
    uctd.TS.map <- plot_grid(uctd.TS, map.uctd.TS, align = "h") 
    # save plot
    ggsave(here("Figs/map_T-S_uctd.png"), uctd.TS.map, 
           width = map.width*2, height = map.height)
  }
  include_graphics(here("Figs/map_T-S_uctd.png"))
} else {
  include_graphics(here("Figs/uctd_missing.png"))
}
```

# Traditional CTD Results
## Cast summary 
Summary of traditional CTD casts conducted during the `r survey.name` aboard _`r survey.vessel`_. 

```{r CTDCastSummary,include=T}
if (length(ctd.hdr) > 0) {
  # make a copy of uctd.summ
  ctd.table <- all.ctd.hdr %>% 
    mutate(cast.date = format(cast.date,"%m/%d/%Y %H:%M:%S"))
  # rename columns
  names(ctd.table) <- c("Order Occupied", "Filename", "Date/time", 
                        "Lat", "Lon", "Depth (m)", "Class", "Leg")
  # print table
  datatable(ctd.table)  
} else {
  cat("No CTD casts processed.")
}
```  

## Cast locations
Location of underway CTD (red numbers) casts. Gray numbers indicate acoustic transect line numbers from the survey instructions. CTD cast numbers correspond to those in the previous table.  

```{r AllCtdMap}
if (draw.figures) {
  if (length(ctd.hdr) > 0) {
    # create main map using ggmap
    map.ctd <- base.map + 
      geom_path(data = nav, aes(long, lat)) + 
      geom_shadowtext(data = ctd.table, aes(x = Lon, y = Lat, label = `Order Occupied`),
                size = 3, colour = "red", bg.color = "white", fontface = "bold")
  } else {
     # create main map using ggmap
    map.ctd <- base.map + 
      geom_path(data = nav, aes(long, lat)) +
      geom_shadowtext(aes(mean(map.bounds$range.lon), mean(map.bounds$range.lat), label = "No CTD casts"), 
                      colour = "black", bg.color = "red", size = 6, fontface = "bold")
  }
  # save map
  ggsave(here("Figs/map_ctd.png"), map.ctd, 
         width = map.width, height = map.height)
}

# Map casts
mapview(nav.sf, color = "black",  alpha = 0.5, layer.name = "Vessel track", col.regions = "black") +
  mapview(ctd.sf, zcol = c("leg"), cex = 4, layer.name = "CTD Casts", legend = T)
```  

## Unprocessed CTD casts  
List of CTD casts not yet processed. 

```{r CTDMissingCasts, include=TRUE}
if (nrow(ctd.missing) > 0) {
  # make a copy of uctd.summ
  ctd.tbl.missing <- ctd.missing %>%
    arrange(cast.date) %>%
    mutate(cast.date = format(cast.date,"%m/%d/%Y %H:%M:%S")) %>% 
    select(Cast = cast, Date = cast.date, Leg = leg)
  
  # print table
  datatable(ctd.tbl.missing)  
} else {
  cat("All UCTD casts have been processed.")
}
```

```{r CombineMaps}
if (draw.figures) {
  # Combine maps
  both.maps <- plot_grid(map.uctd, map.ctd, align = "h", labels = c("UCTD", "CTD"))
  # save plot
  ggsave(here("Figs/map_all_ctds.png"), both.maps, 
         width = map.width*2, height = map.height)
}
```

## Temperature v. Depth plot

```{r CtdTemperatureDepthPlot,out.width="90%",out.height="90%"}
if (length(ctd.hdr) > 0) {
  if (draw.figures) {
    # plot temperature v depth
    ctd.T <- ggplot(data = all.ctd, aes(T, Z, group = cast, colour = factor(cast))) + 
      geom_path(alpha = 0.75) +
      xlab("\nTemperature (C)") + ylab("Depth (m)\n") + 
      scale_x_continuous(limits = c(round(min(all.ctd$T), 0) - 1, round(max(all.ctd$T), 0) + 1),
                         breaks = seq(round(min(all.ctd$T), 0) - 1, round(max(all.ctd$T), 0) + 1, 2),
                         expand = c(0,0)) +
      scale_y_continuous(limits = c(round(min(all.ctd$Z),digits = -1), 0),
                         breaks = seq(round(min(all.ctd$Z),digits = -1), 0, 25),
                         expand = c(0,0)) +
      facet_wrap(~leg, ncol = 2) +
      theme_bw() +
      theme(panel.grid.major = element_line(size = 0.75), 
            legend.position = "none",
            strip.background.x = element_blank(),
            strip.text.x = element_text(face = "bold"))
    
    # save plot
    ggsave(ctd.T, file = here("Figs/ctd_T_v_Z.png"))
  }
  # include_graphics(here("Figs/ctd_T_v_Z.png"))
  ggplotly(ctd.T)
} else {
  include_graphics(here("Figs/ctd_missing.png"))
}
```

## Salinity v. Depth plot

```{r CtdSalinityDepthPlot,out.width="90%",out.height="90%"}
if (length(ctd.hdr) > 0) {
  if (draw.figures) {
    # plot salinity v depth
    ctd.S <- ggplot(data = all.ctd, aes(S, Z, group = cast, colour = factor(cast))) + 
      geom_path(alpha = 0.75) +
      xlab("\nSalinity") + ylab("Depth (m)\n") +
      scale_x_continuous(limits = c(round(min(all.ctd$S),2) - 0.1,round(max(all.ctd$S), 2) + 0.1),
                         breaks = seq(round(min(all.ctd$S),2) - 0.1, round(max(all.ctd$S), 2) + 0.1, 1),
                         expand = c(0,0)) +  
      scale_y_continuous(limits = c(round(min(all.ctd$Z), digits = -1), 0),
                         breaks = seq(round(min(all.ctd$Z), digits = -1), 0, 25), 
                         expand = c(0,0)) + 
      facet_wrap(~leg, ncol = 2) +
      theme_bw() +
      theme(panel.grid.major = element_line(size = 0.75), 
            legend.position = "none",
            strip.background.x = element_blank(),
            strip.text.x = element_text(face = "bold"))
    # save plot
    ggsave(ctd.S,file = here("Figs/ctd_S_v_Z.png"))
  }
  ggplotly(ctd.S)
  # include_graphics(here("Figs/ctd_S_v_Z.png"))
} else {
  include_graphics(here("Figs/ctd_missing.png"))
}
```

## Sound speed v. Depth plot

```{r CtdSoundSpeedDepthPlot,out.width="90%",out.height="90%"}
if (length(ctd.hdr) > 0) {
  if (draw.figures) {
    # plot sound speed v depth
    ctd.Sv <- ggplot(data = all.ctd, aes(Sv, Z, group = cast, colour = factor(cast))) + 
      geom_path(alpha = 0.75) +
      xlab("\nSound speed (m/s)") + ylab("Depth (m)\n") +
      scale_x_continuous(
        limits = c(round(min(all.ctd$Sv), 0) - 1, round(max(all.ctd$Sv), 0) + 1),
        breaks = seq(round(min(all.ctd$Sv), 0) - 1, round(max(all.ctd$Sv), 0) + 1, 10),
        expand = c(0,0)) +  
      scale_y_continuous(
        limits = c(round(min(all.ctd$Z), digits = -1), 0),
        breaks = seq(round(min(all.ctd$Z), digits = -1), 0, 25),
        expand = c(0,0)) + 
      facet_wrap(~leg, ncol = 2) +
      theme_bw() +
      theme(panel.grid.major = element_line(size = 0.75), 
            legend.position = "none",
            strip.background.x = element_blank(),
            strip.text.x = element_text(face = "bold"))
    # save plot
    ggsave(ctd.Sv, file = here("Figs/ctd_sV_v_T.png"))
  }
  ggplotly(ctd.Sv)
  # include_graphics(here("Figs/ctd_sV_v_T.png"))
} else {
  include_graphics(here("Figs/ctd_missing.png"))
}
```

## Temperature-Salinity plot
Temperature-salinity plot for all CTD casts (left) and the location of CTD casts (right), symbolized by water mass.

```{r CTDTsPlot}
if (length(ctd.hdr) > 0) {
  if (draw.figures) {
    # plot salinity v depth
    ctd.TS <- ggplot(all.ctd, aes(S, T, group = cast, colour = factor(class))) + 
      geom_point(alpha = 0.5, size = 2) +
      xlab("\nSalinity") + ylab("Temperature (C)\n") +
      scale_x_continuous(
        limits = c(29,35),
        breaks = seq(29,35,1), 
        expand = c(0,0)) +  
      scale_y_continuous(
        limits = c(floor(min(all.ctd$T)), ceiling(max(all.ctd$T))),
        breaks = seq(floor(min(all.ctd$T)), ceiling(max(all.ctd$T)), 2), 
        expand = c(0,0)) + 
      scale_colour_hue("Water\nmass") +
      theme_bw() +
      theme(panel.grid.major     = element_line(size = 0.75),
            legend.position      = c(0,0),
            legend.justification = c(0,0),
            legend.background    = element_blank())
    # save plot
    ggsave(ctd.TS, file = here("Figs/ctd_S_v_T.png"))
    
    # create main map using ggmap
    map.ctd.TS <- base.map + 
      geom_path(data = nav, aes(long, lat)) + 
      geom_point(data = ctd.table, aes(x = Lon, y = Lat, colour = Class), size = 3, alpha = 0.75) +
      theme(panel.grid.major     = element_line(size = 0.75),
            legend.position      = c(0,0),
            legend.justification = c(0,0),
            legend.background    = element_blank())
    
    # combine plots
    ctd.TS.map <- plot_grid(ctd.TS, map.ctd.TS, align = "h")
    # save plot
    ggsave(ctd.TS.map,file = here("Figs/map_T-S_ctd.png"), 
           width = map.width*2, height = map.height)
  }
  include_graphics(here("Figs/map_T-S_ctd.png"))
} else {
  include_graphics(here("Figs/ctd_missing.png"))
}
```